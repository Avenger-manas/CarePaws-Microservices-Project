name: CarePaws CI Pipeline

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build-and-docker:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Setup Java 17 and Maven
      - name: Setup Java 17 and Maven
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven

      # 3. Debug root folder (optional)
      - name: Debug root folder
        run: pwd && ls -la

      # 4. Build all microservices from root POM
      - name: Build Maven projects
        working-directory: .
        run: mvn clean package -DskipTests

      # 5. Build Docker images for each service
      - name: Build Docker images
        run: |
          services=(carepaws apigateway eureka-server notification-service muncipal-service Report-Service ngo-service/NGO-SERVICE)
          for service in "${services[@]}"; do
            IMAGE_NAME=carepaws-$(echo "$service" | tr '[:upper:]' '[:lower:]' | tr '/' '-')
            echo "Building Docker image for $service â†’ $IMAGE_NAME:latest"
            docker build -t $IMAGE_NAME:latest "$service"
          done

      # 6. Optional: Push to Docker Hub
      # - name: Login to Docker Hub
      #   uses: docker/login-action@v2
      #   with:
      #     username: ${{ secrets.DOCKER_USERNAME }}
      #     password: ${{ secrets.DOCKER_PASSWORD }}
      #
      # - name: Push Docker images
      #   run: |
      #     services=(carepaws apigateway eureka-server notification-service muncipal-service Report-Service ngo-service/NGO-SERVICE)
      #     for service in "${services[@]}"; do
      #       IMAGE_NAME=carepaws-$(echo "$service" | tr '[:upper:]' '[:lower:]' | tr '/' '-')
      #       docker push $IMAGE_NAME:latest
      #     done
